<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Id√©ias sobre desenvolvimento iOS">

    <title>Layouts adaptativos com UICollectionView, Size Classes e Auto Layout - iDeas</title>

    <link rel="canonical" href="http://nobre84.github.io/ios/2016/03/08/layouts-adaptativos-com-uicollectionview-autolayout-e-size-classes/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">
    
    <!-- Share CSS -->
    <link rel="stylesheet" href="/css/share.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link type="application/atom+xml" rel="alternate" href="http://nobre84.github.io/feed.xml" title="" />

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-74878752-1', 'auto');
  ga('send', 'pageview');

</script>
</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">iDeas</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
				
                <li>
                    <a href="/about/">Sobre</a>
                </li>
				
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/borges/viva-cover.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Layouts adaptativos com UICollectionView, Size Classes e Auto Layout</h1>
                    
                    <span class="meta">Postado por Rodrigo Borges em 8/03/2016</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="share">
  <li><a href="https://twitter.com/intent/tweet?text=Layouts adaptativos com UICollectionView, Size Classes e Auto Layout&url=http://nobre84.github.io/ios/2016/03/08/layouts-adaptativos-com-uicollectionview-autolayout-e-size-classes/" rel="nofollow" target="_blank" title="Share on Twitter"><i class="fa fa-twitter-square"></i></a></li>
  <li><a href="https://facebook.com/sharer.php?u=http://nobre84.github.io/ios/2016/03/08/layouts-adaptativos-com-uicollectionview-autolayout-e-size-classes/" rel="nofollow" target="_blank" title="Share on Facebook"><i class="fa fa-facebook-square"></i></a></li>
  <li><a href="http://www.linkedin.com/shareArticle?mini=true&url=http://nobre84.github.io/ios/2016/03/08/layouts-adaptativos-com-uicollectionview-autolayout-e-size-classes/" rel="nofollow" target="_blank" title="Share on Linkedlin"><i class="fa fa-linkedin-square"></i></a></li>
  <li><a href="https://plus.google.com/share?url=http://nobre84.github.io/ios/2016/03/08/layouts-adaptativos-com-uicollectionview-autolayout-e-size-classes/" rel="nofollow" target="_blank" title="Share on Google+"><i class="fa fa-google-plus-square"></i></a></li>
</ul>
                
				<blockquote>
  <p>Meu nome √© Rodrigo Borges (<a href="https://www.twitter.com/rdgborges">@rdgborges</a>). Sou manauara e moro em S√£o Paulo. Passei uma temporada em BH, onde fiz um mestrado em Computa√ß√£o Ub√≠qua. J√° trabalhei com Maemo, MeeGo, Symbian, Windows Phone e Android. Atualmente sou desenvolvedor iOS no <a href="https://itunes.apple.com/br/app/vivareal-imoveis-casas-condominios/id655245656?mt=8">VivaReal</a> e desenvolvedor/co-fundador no <a href="https://itunes.apple.com/us/app/meatless-sao-paulo-sp/id1080837095?l=pt&amp;ls=1&amp;mt=8">Meatless</a>, onde estou tentando reduzir o consumo de carne no mundo com alguns amigos.</p>
</blockquote>

<p>Quando entrei no VivaReal, um dos meus primeiros desafios foi desenvolver a nova p√°gina de detalhes do im√≥vel (PDP, do ingl√™s, Property Details Page). Para isso, eu precisei utilizar UICollectionView, Auto Layout, Size Classes, capturar eventos de mudan√ßa de tamanho da tela, criar um layout espec√≠fico para o iPad e suportar Multitasking. Um pequeno detalhe: eu nunca tinha trabalhado com nada disso. ü§ìüëç</p>

<p>O objetivo desse artigo √© mostrar que com um esfor√ßo relativamente pequeno, voc√™ consegue aproveitar ao m√°ximo o tamanho da tela do device do seu usu√°rio (seja qual iDevice for) para criar uma interface bonita e adaptativa.</p>

<h2 id="property-details-page">Property Details Page</h2>

<p>No <a href="https://itunes.apple.com/br/app/vivareal-imoveis-casas-condominios/id655245656?mt=8">app do VivaReal</a>, a PDP √© um View Controller que mostra detalhes de um im√≥vel selecionado pelo usu√°rio. Ela √© composta por v√°rias se√ß√µes com informa√ß√µes como pre√ßos do aluguel e condom√≠nio, localiza√ß√£o, descri√ß√£o, formul√°rio para contato e outros detalhes.</p>

<center><b>PDP no iPad</b></center>
<p><img src="/img/borges/viva-ipad1.png" alt="" /></p>

<center><b>PDP no iPhone</b></center>
<center><img src="/img/borges/viva-iphone1.png" alt="" /></center>

<p>Toda Collection View possui um objeto do tipo <strong>UICollectionViewLayout</strong>, que √© o respons√°vel por definir o tamanho, posi√ß√£o e outros atributos das c√©lulas e se√ß√µes. A PDP antiga utilizava o layout padr√£o para Collection Views disponibilizado no UIKit, o <strong>UICollectionViewFlowLayout</strong>.</p>

<blockquote>
  <p>Apesar de ser customiz√°vel em v√°rios aspectos, um dos principais problemas desse layout √© n√£o poder posicionar as c√©lulas de outra forma que n√£o seja um grid, isto √©, baseado em linhas e colunas.¬†</p>
</blockquote>

<p>Outro problema que identifiquei foi o tamanho das c√©lulas em uma mesma linha. Geralmente, a altura de uma linha √© determinada pela c√©lula de maior altura. Dessa forma, na PDP antiga, haviam v√°rios espa√ßos em branco entre c√©lulas de linhas diferentes, pois as c√©lulas costumam variar bastante de tamanho.</p>

<h2 id="custom-layouts">Custom Layouts</h2>

<p>Para resolver esse problema, chegamos a uma alternativa: <strong>Custom Layouts</strong>. Segundo a <a href="https://developer.apple.com/library/ios/documentation/WindowsViews/Conceptual/CollectionViewPGforIOS/CreatingCustomLayouts/CreatingCustomLayouts.html">Apple</a>, Custom Layouts devem ser considerados se:</p>

<ol>
  <li>O layout n√£o se parece com um grid, um layout baseado em linhas ou suporta scroll em mais de uma dire√ß√£o;</li>
  <li>Voc√™ precisa mudar a posi√ß√£o das c√©lulas constantemente.</li>
</ol>

<p>No nosso caso, percebemos que satisfaz√≠amos ambos os pontos.¬†</p>

<ul>
  <li>
    <p>Primeiro, o nosso layout para uma tela maior, como a do iPad, n√£o tem o conceito de linhas, apesar de ter o de colunas. As c√©lulas deveriam ser posicionadas nas colunas logo abaixo das √∫ltimas c√©lulas adicionadas, sem se importar com o tamanho destas.</p>
  </li>
  <li>
    <p>Segundo, de acordo com o tamanho da tela, as c√©lulas da nossa PDP devem ter posi√ß√µes diferentes para facilitar a visualiza√ß√£o das informa√ß√µes. Por exemplo, no iPad em <em>portrait</em>, a c√©lula de localiza√ß√£o deve vir logo ap√≥s a c√©lula de resumo de pre√ßo e caracter√≠sticas. J√° em <em>landscape</em>, a c√©lula de descri√ß√£o do im√≥vel √© que vem logo abaixo da c√©lula de resumo.</p>
  </li>
</ul>

<p>Todos esses pontos nos levaram a utilizar um Custom Layout para implementar nossa nova PDP. üëå</p>

<h3 id="criando-a-subclasse-da-uicollectionviewlayout">Criando a subclasse da UICollectionViewLayout</h3>

<p>A primeira coisa a se fazer quando implementando um Custom Layout √© criar uma <strong>subclasse</strong> da UICollectionViewLayout. Ela deve implementar 3 m√©todos principais, que s√£o os respons√°veis por indicar √† Collection View os tamanhos e posi√ß√µes das c√©lulas.</p>

<ul>
  <li>prepareLayout</li>
  <li>collectionViewContentSize</li>
  <li>layoutAttributesForElementsInRect:</li>
</ul>

<p>O m√©todo prepareLayout possui a implementa√ß√£o mais complexa dos 3, pois ele varia de acordo com a complexidade do layout da sua Collection View. Os outros 2 m√©todos apenas retornam objetos que calculamos no prepareLayout, como veremos mais √† frente.</p>

<h3 id="mtodo-preparelayout">M√©todo prepareLayout</h3>

<p>No m√©todo prepareLayout, deve-se determinar a posi√ß√£o de cada c√©lula. No fim desse m√©todo, √© preciso ter o m√≠nimo de informa√ß√£o para definir a √°rea total do conte√∫do da Collection View (n√£o somente a √°rea vis√≠vel).</p>

<p>Criamos algumas vari√°veis globais do layout para nos auxiliar e evitar recalcular o layout a cada pequena intera√ß√£o do usu√°rio com a Collection View:</p>

<ul>
  <li><strong>attributesCache</strong>: Array que armazena os atributos do layout de cada c√©lula;</li>
  <li><strong>contentWidth</strong> e <strong>contentHeight</strong>: Armazenam a largura e altura do conte√∫do da Collection View. S√£o atualizados sempre que a posi√ß√£o de uma c√©lula √© determinada.</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">override</span> <span class="kd">func</span> <span class="nf">prepareLayout</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">let</span> <span class="nv">numberOfColumns</span> <span class="o">=</span> <span class="nf">columnsBasedOnScreen</span><span class="p">()</span>
    <span class="n">attributesCache</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">contentHeight</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1">// 1    </span>
    <span class="c1">// Initializes offsets arrays</span>
    <span class="k">let</span> <span class="nv">columnWidth</span> <span class="o">=</span> <span class="n">contentWidth</span> <span class="o">/</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="n">numberOfColumns</span><span class="p">)</span>
    <span class="k">var</span> <span class="nv">yOffset</span> <span class="o">=</span> <span class="p">[</span><span class="kt">CGFloat</span><span class="p">](</span><span class="nv">count</span><span class="p">:</span> <span class="n">numberOfColumns</span><span class="p">,</span> <span class="nv">repeatedValue</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">var</span> <span class="nv">xOffset</span> <span class="o">=</span> <span class="p">[</span><span class="kt">CGFloat</span><span class="p">]()</span>
    <span class="k">for</span> <span class="n">column</span> <span class="k">in</span> <span class="mi">0</span> <span class="o">..&lt;</span> <span class="n">numberOfColumns</span> <span class="p">{</span>
        <span class="n">xOffset</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="kt">CGFloat</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="o">*</span> <span class="n">columnWidth</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">var</span> <span class="nv">column</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">item</span> <span class="k">in</span> <span class="mi">0</span> <span class="o">..&lt;</span> <span class="n">collectionView</span><span class="o">!.</span><span class="nf">numberOfItemsInSection</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 2    </span>
        <span class="c1">// Calculates cell frame</span>
        <span class="k">let</span> <span class="nv">indexPath</span> <span class="o">=</span> <span class="kt">NSIndexPath</span><span class="p">(</span><span class="nv">forItem</span><span class="p">:</span> <span class="n">item</span><span class="p">,</span> <span class="nv">inSection</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">itemHeight</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">.</span><span class="nf">heightForItemAtIndexPath</span><span class="p">(</span><span class="n">indexPath</span><span class="p">,</span> <span class="nv">withWidth</span><span class="p">:</span> <span class="n">columnWidth</span><span class="p">)</span>

        <span class="k">var</span> <span class="nv">frame</span><span class="p">:</span> <span class="kt">CGRect</span>
        <span class="c1">// 3</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="c1">// if first cell, cell width == content width</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="kt">CGRect</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="n">xOffset</span><span class="p">[</span><span class="n">column</span><span class="p">],</span> <span class="nv">y</span><span class="p">:</span> <span class="n">yOffset</span><span class="p">[</span><span class="n">column</span><span class="p">],</span> <span class="nv">width</span><span class="p">:</span> <span class="n">contentWidth</span><span class="p">,</span> <span class="nv">height</span><span class="p">:</span> <span class="n">itemHeight</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// cell width == column width</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="kt">CGRect</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="n">xOffset</span><span class="p">[</span><span class="n">column</span><span class="p">],</span> <span class="nv">y</span><span class="p">:</span> <span class="n">yOffset</span><span class="p">[</span><span class="n">column</span><span class="p">],</span> <span class="nv">width</span><span class="p">:</span> <span class="n">columnWidth</span><span class="p">,</span> <span class="nv">height</span><span class="p">:</span> <span class="n">itemHeight</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1">// 4    </span>
        <span class="c1">// Append cell attributes to cache</span>
        <span class="k">let</span> <span class="nv">attributes</span> <span class="o">=</span> <span class="kt">UICollectionViewLayoutAttributes</span><span class="p">(</span><span class="nv">forCellWithIndexPath</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span>
        <span class="n">attributes</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="n">attributesCache</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>

        <span class="c1">// 5    </span>
        <span class="c1">// Updates contentHeight</span>
        <span class="n">contentHeight</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">contentHeight</span><span class="p">,</span> <span class="kt">CGRectGetMaxY</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>

        <span class="c1">// 6</span>
        <span class="c1">// Updates y position of next cell</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..&lt;</span><span class="n">yOffset</span><span class="o">.</span><span class="n">count</span> <span class="p">{</span>
                <span class="n">yOffset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">itemHeight</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">yOffset</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">yOffset</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">+</span> <span class="n">itemHeight</span>
        <span class="p">}</span>

        <span class="c1">// 7</span>
        <span class="c1">// Determines column where next cell will be placed</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="n">column</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">column</span> <span class="o">=</span> <span class="n">column</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">numberOfColumns</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">?</span> <span class="mi">0</span> <span class="p">:</span> <span class="o">++</span><span class="n">column</span>
        <span class="p">}</span>

    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<ol>
  <li>Inicializa√ß√£o dos Arrays xOffset e yOffset. A partir desses Arrays, calculamos a posi√ß√£o de cada c√©lula na Collection View. Eles s√£o atualizados cada vez que a posi√ß√£o de uma c√©lula √© calculada para sabermos onde posicionar a pr√≥xima c√©lula da lista;</li>
  <li>C√°lculo do frame da c√©lula baseado na largura da coluna e na sua altura;</li>
  <li>Caso o item seja o primeiro (c√©lula das fotos), a largura √© igual a largura da Collection View. Caso contr√°rio, √© igual a largura da coluna;</li>
  <li>Ap√≥s o frame da c√©lula ser definido, o objeto de atributos da c√©lula √© adicionado ao cache. Este ser√° utilizado posteriormente no m√©todo layoutAttributesForElementsInRect:;</li>
  <li>Atualiza-se a altura da √°rea de conte√∫do da Collection View, o qual ser√° utilizada no m√©todo collectionViewContentSize;</li>
  <li>Atualiza a posi√ß√£o em que a pr√≥xima c√©lula da coluna ser√° posicionada, de acordo com a altura e posi√ß√£o da c√©lula atual.</li>
  <li>Determina a coluna onde a pr√≥xima c√©lula ser√° colocada;</li>
</ol>

<p>Para definir o posicionamento das c√©lulas, decidimos criar um m√©todo que analisa a <strong>orienta√ß√£o</strong> do device e <strong>Size Class</strong> da tela e retorna o n√∫mero de colunas em que o layout ser√° dividido.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">columnsBasedOnScreen</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Int</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">orientation</span> <span class="o">=</span> <span class="kt">UIApplication</span><span class="o">.</span><span class="nf">sharedApplication</span><span class="p">()</span><span class="o">.</span><span class="n">statusBarOrientation</span>
    <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="kt">UIInterfaceOrientation</span><span class="o">.</span><span class="kt">Portrait</span> <span class="o">||</span> <span class="n">orientation</span> <span class="o">==</span> <span class="kt">UIInterfaceOrientation</span><span class="o">.</span><span class="kt">PortraitUpsideDown</span> <span class="p">{</span>
        <span class="c1">// portrait</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// landscape</span>
        <span class="k">let</span> <span class="nv">horizontalSizeClass</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">collectionView</span><span class="p">?</span><span class="o">.</span><span class="n">traitCollection</span><span class="o">.</span><span class="n">horizontalSizeClass</span>
        <span class="k">let</span> <span class="nv">verticalSizeClass</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">collectionView</span><span class="p">?</span><span class="o">.</span><span class="n">traitCollection</span><span class="o">.</span><span class="n">verticalSizeClass</span>

        <span class="k">if</span> <span class="n">horizontalSizeClass</span> <span class="o">==</span> <span class="kt">UIUserInterfaceSizeClass</span><span class="o">.</span><span class="kt">Regular</span> <span class="o">&amp;&amp;</span> <span class="n">verticalSizeClass</span> <span class="o">==</span> <span class="kt">UIUserInterfaceSizeClass</span><span class="o">.</span><span class="kt">Regular</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">applicationDelegate</span> <span class="o">=</span> <span class="kt">UIApplication</span><span class="o">.</span><span class="nf">sharedApplication</span><span class="p">()</span><span class="o">.</span><span class="n">delegate</span>

            <span class="k">guard</span> <span class="k">let</span> <span class="nv">delegate</span> <span class="o">=</span> <span class="n">applicationDelegate</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="mi">1</span>
            <span class="p">}</span>

            <span class="k">guard</span> <span class="k">let</span> <span class="nv">window</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">.</span><span class="n">window</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="mi">1</span>
            <span class="p">}</span>

            <span class="k">let</span> <span class="nv">isFullscreen</span> <span class="o">=</span> <span class="kt">CGRectEqualToRect</span><span class="p">(</span><span class="n">window</span><span class="o">!.</span><span class="n">frame</span><span class="p">,</span> <span class="n">window</span><span class="o">!.</span><span class="n">screen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">isFullscreen</span> <span class="p">{</span>
                <span class="k">return</span> <span class="mi">2</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="mi">1</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="p">}</span>

    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<ul>
  <li>Caso o device esteja em portrait, o layout da Collection View sempre ser√° baseado em 1 coluna.</li>
  <li>Caso esteja em landscape, as Size Classes horizontais e verticais s√£o verificadas:
    <ul>
      <li>Se s√£o ambas Regular, significa que estamos em uma tela grande, como o iPad. Nesse caso, precisamos checar tamb√©m se o usu√°rio est√° utilizando Multitasking ou n√£o. Isso √© feito facilmente comparando o window.frame com o window.screen.bounds.</li>
      <li>Caso contr√°rio, estamos em uma tela menor, e, por isso, utilizamos o layout normal baseado em 1 coluna.</li>
    </ul>
  </li>
</ul>

<h3 id="mtodo-collectionviewcontentsize">M√©todo collectionViewContentSize</h3>

<p>Com as informa√ß√µes calculadas no m√©todo prepareLayout, √© poss√≠vel definir a √°rea total do conte√∫do da Collection View. O retorno do m√©todo √© um objeto do tipo CGSize.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">override</span> <span class="kd">func</span> <span class="nf">collectionViewContentSize</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">CGSize</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kt">CGSize</span><span class="p">(</span><span class="nv">width</span><span class="p">:</span> <span class="n">contentWidth</span><span class="p">,</span> <span class="nv">height</span><span class="p">:</span> <span class="n">contentHeight</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<p>No nosso caso, √† medida que calculamos as posi√ß√µes e tamanhos das c√©lulas no m√©todo <strong>prepareLayout</strong>, atualizamos duas vari√°veis globais da classe: <strong>contentWidth</strong> e <strong>contentHeight</strong>. Dentro do m√©todo collectionViewContentSize() criamos uma CGSize e a retornamos.</p>

<h3 id="mtodo-layoutattributesforelementsinrect">M√©todo layoutAttributesForElementsInRect:</h3>

<p>Esse m√©todo √© chamado pela Collection View para saber os atributos das c√©lulas que est√£o dentro de um ret√¢ngulo passado como par√¢metro. O retorno do m√©todo deve ser um <strong>Array de UICollectionViewLayoutAttributes</strong>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">override</span> <span class="kd">func</span> <span class="nf">layoutAttributesForElementsInRect</span><span class="p">(</span><span class="nv">rect</span><span class="p">:</span> <span class="kt">CGRect</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="kt">UICollectionViewLayoutAttributes</span><span class="p">]?</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">layoutAttributes</span> <span class="o">=</span> <span class="p">[</span><span class="kt">UICollectionViewLayoutAttributes</span><span class="p">]()</span>

    <span class="k">for</span> <span class="n">attributes</span> <span class="k">in</span> <span class="n">attributesCache</span> <span class="p">{</span>
        <span class="k">if</span> <span class="kt">CGRectIntersectsRect</span><span class="p">(</span><span class="n">attributes</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="n">rect</span><span class="p">){</span>
            <span class="n">layoutAttributes</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">layoutAttributes</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Os atributos de cada c√©lula s√£o informa√ß√µes que tamb√©m podemos calcular e armazenar durante a execu√ß√£o do m√©todo <strong>prepareLayout</strong>. Neste m√©todo, criamos um Array de UICollectionViewLayoutAttributes e, √† medida que definimos as posi√ß√µes das c√©lulas, vamos adicionando seus atributos no Array.</p>

<p>Feito isso, no layoutAttributesForElementsInRect:, basta iterarmos sobre o Array de atributos e utilizar o m√©todo CGRectIntersectsRect para identificar quais c√©lulas cujos frames intersectam o ret√¢ngulo passado como par√¢metro.</p>

<h3 id="definindo-o-novo-layout-da-collection-view">Definindo o novo layout da Collection View</h3>

<p>Uma vez que temos o nosso Custom Layout implementado, precisamos defini-lo como layout da nossa Collection View. Para isso, bastamos selecion√°-la no Storyboard, abrir o Attributes Inspector, selecionar o tipo do layout como <strong>Custom</strong> e a classe do layout.</p>

<p><img src="/img/borges/viva-storyboard5.png" alt="" /></p>

<h3 id="atualizando-o-layout-aps-a-transio-de-tamanho-de-tela">Atualizando o layout ap√≥s a transi√ß√£o de tamanho de tela</h3>

<p>Precisamos avisar a collection View para recalcular a posi√ß√£o das c√©lulas e √°rea do conte√∫do toda vez que houver uma mudan√ßa de tamanho ou orienta√ß√£o da tela.</p>

<p>Para isso, basta-se fazer um override do m√©todo <strong>viewWillTransitionToSize</strong> da nossa View Controller e chamar o m√©todo <strong>invalidateLayout</strong> no layout da nossa Collection View. Assim, o m√©todo <strong>prepareLayout</strong> ser√° chamado novamente, atualizando todas as informa√ß√µes de layout e posicionamento das c√©lulas.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">override</span> <span class="kd">func</span> <span class="nf">viewWillTransitionToSize</span><span class="p">(</span><span class="nv">size</span><span class="p">:</span> <span class="kt">CGSize</span><span class="p">,</span> <span class="n">withTransitionCoordinator</span> <span class="nv">coordinator</span><span class="p">:</span> <span class="kt">UIViewControllerTransitionCoordinator</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="o">.</span><span class="nf">viewWillTransitionToSize</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nv">withTransitionCoordinator</span><span class="p">:</span> <span class="n">coordinator</span><span class="p">)</span>

    <span class="k">self</span><span class="o">.</span><span class="n">collectionView</span><span class="o">.</span><span class="n">collectionViewLayout</span><span class="o">.</span><span class="nf">invalidateLayout</span><span class="p">()</span>
    <span class="k">self</span><span class="o">.</span><span class="n">collectionView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>
<span class="p">}</span>
</code></pre>
</div>

<h2 id="mostrando-views-de-acordo-com-a-size-class">Mostrando Views de acordo com a Size Class</h2>

<p>Outra caracter√≠stica interessante da PDP √© que, em telas menores, o formul√°rio de contato com o anunciante deve ser implementado como √∫ltima c√©lula da Collection View. J√° em telas maiores (iPad), ele deve ficar fixo no lado direito do layout, independente da Collection View.</p>

<p><img src="/img/borges/viva-ipad4.png" alt="" /></p>

<h3 id="size-classes">Size Classes</h3>

<p>Desde a cria√ß√£o das <a href="https://developer.apple.com/library/ios/recipes/xcode_help-IB_adaptive_sizes/chapters/AboutAdaptiveSizeDesign.html">Size Classes</a>, o desenvolvimento de interfaces universais no iOS deixou de ser dividido em iPhone e iPad para levar em considera√ß√£o duas classes: <strong>Regular</strong> e <strong>Compact</strong> combinadas com as duas dimens√µes: <strong>Width</strong> e <strong>Height</strong>.</p>

<p>Cada combina√ß√£o poss√≠vel entre elas define um tipo de tamanho de tela, levando em conta tamb√©m a orienta√ß√£o do device. Por exemplo, <strong>Compact Height</strong> define a tela dos iPhones em landscape. J√° <strong>Regular Width/Regular Height</strong> define a tela dos iPads, seja em portrait ou landscape.</p>

<p>Quando voc√™ baseia o layout em Size Classes, a interface do seu app pode se comportar bem em qualquer tipo de tela, seja ela de um iPhone, iPhone Plus, de um iPad ou iPad Pro, em portrait ou landscape.</p>

<h3 id="modificando-constraints-para-uma-size-class">Modificando constraints para uma Size Class</h3>

<p>No Storyboard √© poss√≠vel alterar a Size Class do layout na barra que fica logo acima da Debug area.¬†Inicialmente, a Size Class selecionada √© a Any Width/Any Height, o que significa que as constraints e Views configuradas no atual Storyboard ser√£o aplicadas a todas as Size Classes.</p>

<center><img src="/img/borges/viva-storyboard4.png" alt="" /></center>

<p>Quando mudamos para uma outra Size Class, podemos configurar como nossa interface se comportar√° neste tamanho espec√≠fico da tela, sem modificar o seu comportamento no restante das classes.</p>

<p>No nosso caso, queremos que a View de formul√°rio de contato apare√ßa apenas quando o usu√°rio estiver em um tamanho de tela grande como o do iPad. Logo, selecionamos Regular Width/Regular Height como nossa Size Class e modificamos a interface para tornar o formul√°rio vis√≠vel.</p>

<p>A modifica√ß√£o foi alterar as <strong>constraints do Auto Layout</strong> que definem o espa√ßo √† direita da Collection View e a largura do formul√°rio. Assim, no iPad, a Collection View acompanhar√° a largura do formul√°rio, se mantendo √† esquerda dele, enquanto que, nos outros tamanhos de tela, ela ocupar√° toda a extens√£o do View Controller.</p>

<table>
  <thead>
    <tr>
      <th>Any Width, Any Height</th>
      <th>Regular Width, Regular Height</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><img src="/img/borges/viva-storyboard2.png" alt="" /></td>
      <td><img src="/img/borges/viva-storyboard1.png" alt="" /></td>
    </tr>
  </tbody>
</table>

<h3 id="instalando-uma-view-de-acordo-com-a-size-class">Instalando uma View de acordo com a Size Class</h3>

<p>Voc√™ deve estar se perguntando: O que acontece com a nossa View lateral de formul√°rio no iPhone? ü§î Ela √© criada e ocupa mem√≥ria mesmo nunca sendo utilizada l√°? üò±</p>

<p>Felizmente o Xcode fornece um meio de configurar se uma View ser√° computada ou n√£o de acordo com a Size Class. Para isso, precisamos apenas selecionar a View em quest√£o no Storyboard, selecionar o Attributes Inspector e, l√° no final, adicionar as Size Classes em que a View ser√° ‚Äúinstalada‚Äù. Dessa forma, a View far√° parte da hierarquia de Views do layout apenas nas Size Classes em que aparece, sem gastar recursos do sistema nas outras.</p>

<center><img src="/img/borges/viva-storyboard3.png" alt="" /></center>

<p>O formul√°rio √© instalado apenas quando em Regular Width/Regular Height. J√° o bot√£o de ‚ÄúContatar anunciante‚Äù, que aparece na parte inferior da tela, √© instalado em todas as Size Classes, exceto nas Regular.</p>

<h2 id="multitasking">Multitasking</h2>

<p>Quando voc√™ desenvolve sua app baseando-se em Size Classes e Auto Layout, ela se adaptar√° automaticamente durante o uso de Multitasking! üéâ</p>

<p>No fim das contas, durante as mudan√ßas de tamanho no Multitasking, a app estar√° apenas trocando de Size Class. Como sua Collection View est√° escutando as mudan√ßas de Size Class, recalculando seu layout e suas Views est√£o sendo instaladas conforme a Size Class, n√£o precisa fazer mais nada para adaptar seu layout.</p>

<p><img src="/img/borges/viva-ipad3.png" alt="" /></p>

<p><img src="/img/borges/viva-ipad2.png" alt="" /></p>

<p>Segundo a <a href="https://developer.apple.com/library/prerelease/ios/documentation/WindowsViews/Conceptual/AdoptingMultitaskingOniPad/index.html">Apple</a>:</p>

<blockquote>
  <p>From a development perspective, the biggest change is about resource management.</p>
</blockquote>

<p>Ent√£o o maior problema a ser tratado durante o Multitasking √© o gerenciamento de recursos e mem√≥ria. Conceitos como instala√ß√£o ou n√£o de Views baseados em Size Classes ajudam a utilizar o m√≠nimo de recursos poss√≠veis e compartilh√°-los com outras apps.</p>

<h2 id="concluso">Conclus√£o</h2>

<p>Vimos aqui como foi implementada a PDP do app do VivaReal, onde o desafio foi criar a melhor experi√™ncia pro usu√°rio que o tamanho de tela do seu device permitisse.</p>

<p>Utilizamos UICollectionViews e Custom Layouts para definir a l√≥gica de cria√ß√£o do nosso layout, nos baseando nas Size Classes para saber como posicionar as c√©lulas e quais Views aparecem ou n√£o em cada tamanho de tela.</p>

<p>N√£o deixe de ler e compartilhar tamb√©m os outros artigos do EquinociOS, uma excelente iniciativa da comunidade do <a href="http://www.cocoaheads.com.br">CocoaHeads Brasil</a>! üëèü§ì</p>

<h2 id="referncias">Refer√™ncias</h2>
<ol>
  <li><a href="https://github.com/rdgborges/VivaRealPDPExample">Projeto Demo</a>. Disponibilizado no meu perfil do Github.</li>
  <li><a href="http://www.raywenderlich.com/78550/beginning-ios-collection-views-swift-part-1">UICollectionViews Tutorial</a>. Ray Wenderlich.</li>
  <li><a href="http://www.raywenderlich.com/107439/uicollectionview-custom-layout-tutorial-pinterest">UICollectionView Custom Layout Tutorial</a>. Ray Wenderlich.</li>
  <li><a href="https://developer.apple.com/library/ios/documentation/WindowsViews/Conceptual/CollectionViewPGforIOS/CreatingCustomLayouts/CreatingCustomLayouts.html">Creating Custom Layouts</a>. Apple iOS Developer Library.</li>
  <li><a href="https://developer.apple.com/library/ios/recipes/xcode_help-IB_adaptive_sizes/chapters/AboutAdaptiveSizeDesign.html">About Designing for Multiple Size Classes</a>. Apple iOS Developer Library.</li>
  <li><a href="https://developer.apple.com/library/ios/recipes/xcode_help-IB_adaptive_sizes/chapters/EnableAndDisableViews.html">Installing and Uninstalling Views for a Size Class</a>. Apple iOS Developer Library.</li>
  <li><a href="https://developer.apple.com/library/prerelease/ios/documentation/WindowsViews/Conceptual/AdoptingMultitaskingOniPad/index.html">Adopting Multitasking Enhancements on iPad</a>. Apple iOS Developer Library.</li>
</ol>


                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/arquitetura/2016/03/07/minimizando-acoplamento-view-e-viewcontrollers/" data-toggle="tooltip" data-placement="top" title="Minimizando o acoplamento entre Views e ViewControllers">&larr; Post Anterior</a>
                    </li>
                    
                    
                </ul>

                <!-- Disqus Content -->

                <div id="disqus_thread">
                    <script>
                        /**
                        * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                        * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
                        */
                        
                        /*
                        var disqus_config = function () {
                            this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
                            this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                        };
                        */

                        (function() { // DON'T EDIT BELOW THIS LINE
                        var d = document, s = d.createElement('script');

                        s.src = '//nobre84.disqus.com/embed.js';

                        s.setAttribute('data-timestamp', +new Date());
                        (d.head || d.body).appendChild(s);
                        })();
                    </script>
                    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
                </div>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/nobre84">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.facebook.com/nobre84">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/nobre84">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="mailto:nobre84@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted"><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Licen√ßa Creative Commons" style="border-width:0; display: inline;" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" /></a><br />Este obra est√° licenciado com uma Licen√ßa <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Atribui√ß√£o-N√£oComercial 4.0 Internacional</a>.</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


</body>

</html>
